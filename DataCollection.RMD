---
title: 'Machine Learning'
date: "7/5/2022"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction: Please Read

## Data Collection


### 1A) Collection:

Handwritten digits are from ten individuals. Each individual is to write each digit (0 - 9) five times (50 written digits). Digits should be written in Black ink (consider a sharpie, black marker, or a highly legible pen) upon white paper (such as computer paper). 

The dataset have 50 copies of every digit (0 - 9), 500 total digits. Digitize each images with a clear camera, and save these into a .ZIP file. 

### 1B) Data Processing

Individual MNIST digits are 28x28 grayscale images with pixel values between 0 and 255. A processed MNIST digit is "flattened" into an array of length 784 (28x28). The collection of MNIST digits are stored in a Matrix, with each row representing the array of one image. 500 handwritten digits should be processed into one Matrix with dimensions 784x500.

Labels are stored as an array of integers. 500 labels should be stored in one array, length 500.


#### About MNIST:

The MNIST dataset dataset is available as four file downloads. 

```{r Q1B}
library(dslabs)

mnist <- read_mnist()
i <- 5
image(1:28, 1:28, matrix(mnist$test$images[i,], nrow=28)[ , 28:1], 
    col = gray(seq(0, 1, 0.05)), xlab = "", ylab="")
## the labels for this image is: 
mnist$test$labels[i]


```


## Q2: Classification Algorithms

Using the MNIST data set, you will train three algorithms on the MNIST training images and labels (N=60,000), and validate in order to tune your model using the MNIST testing images and labels (N=10,000). 

Consider improving your algorithm by tuning parameters and re-validating. Also consider feature engineering, such as Dimension Reduction using PCA.

You will then test your algorithm using your 500 handwritten digits collected in Q1. 

Print two elements demonstrating the result of your test:

1. The Confusion Matrix of your predicted vs true labels
2. The accuracy of predicting your label, as a percentage (e.g. 50%) 
```{r Q2 set up}
library(caret)
library(caTools)
library(class)
library(factoextra)
library(corrplot)
library(rpart)
library(rpart.plot)
library(randomForest)
library(imager)
library(FactoMineR)
library(forecast)
library(car)

#show digit
show_digit = function(arr784, col = gray(12:1 / 12), ...) {image(matrix(as.matrix(arr784[-785]), nrow = 28)[, 28:1], col =gray(seq(0, 1, 0.05)), ...)}

#load image file
load_image_file = function(filename) {
  ret = list()
  f = file(filename, 'rb')
  readBin(f, 'integer', n = 1, size = 4, endian = 'big')
  n    = readBin(f, 'integer', n = 1, size = 4, endian = 'big')
  nrow = readBin(f, 'integer', n = 1, size = 4, endian = 'big')
  ncol = readBin(f, 'integer', n = 1, size = 4, endian = 'big')
  x = readBin(f, 'integer', n = n * nrow * ncol, size = 1, signed = FALSE)
  close(f)
  data.frame(matrix(x, ncol = nrow * ncol, byrow = TRUE))
}


# load label files
load_label_file = function(filename) {
  f = file(filename, 'rb')
  readBin(f, 'integer', n = 1, size = 4, endian = 'big')
  n = readBin(f, 'integer', n = 1, size = 4, endian = 'big')
  y = readBin(f, 'integer', n = n, size = 1, signed = FALSE)
  close(f)
  y
}

# load images
train = load_image_file("train-images-idx3-ubyte")
test  = load_image_file("t10k-images-idx3-ubyte")

# load labels
train$y = as.factor(as.character(load_label_file("train-labels-idx1-ubyte")))
test$y  = as.factor(load_label_file("t10k-labels-idx1-ubyte"))

#Split Data
set.seed(61710)



#apply pca
trainPredictors.mnist = train[,-785]
testPredictors.mnist = test[,-785]

#determine number of components
#pca.mnist = PCA(trainPredictors.mnist, graph = F)
#pca.mnist$eig  
pca = prcomp(trainPredictors.mnist)
fviz_eig(pca,addlabels = T,n=260) #A 236-component structure suggested by the Scree plot. It would explain more than 90% of the original data. 

#apply component structure
train_components.mnist = data.frame(cbind(pca$x[,1:236], y=train['y']))
test_pca.mnist = predict(pca,newdata=testPredictors.mnist)
test_components.mnist = data.frame(cbind(test_pca.mnist[,1:236], y = test['y']))


#save to csv
write.csv(train_components.mnist,"C:/.../train_components.csv",row.names = FALSE)
write.csv(test_components.mnist,"C:/.../test_components.csv",row.names = FALSE)

#read
train_components.mnist = read.csv("C:/.../train_components.csv",header =TRUE)
test_components.mnist =  read.csv("C:/.../test_components.csv",header =TRUE)


#read 500 handwritten digits
digits = as.matrix(read.table("C:/.../imageMatrix.txt", sep="\t",header=TRUE))
digits = as.data.frame(digits)

digits_pca = predict(pca,newdata=digits)
digits_components = data.frame(cbind(digits_pca[,1:236], y = digits$y))

digits_components[,'y'] = as.factor(digits_components[,'y'])

write.csv(digits_components,"C:/.../digits_components.csv",row.names = FALSE)
digits_components = read.csv("C:/.../digits_components.csv",header =TRUE)

```

